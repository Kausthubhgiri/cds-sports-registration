<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Edit Entries ‚Äì CDS Sports Meet</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      padding: 2rem;
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 1rem;
    }
    #schoolHeader {
      font-size: 1.2rem;
      margin-bottom: 1rem;
    }
    .actions {
      margin-bottom: 1.5rem;
    }
    button {
      padding: 0.5rem 1rem;
      font-size: 1rem;
      margin-right: 1rem;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
    }
    th, td {
      padding: 0.5rem;
      border: 1px solid #ccc;
      text-align: left;
    }
    img {
      max-width: 80px;
      border-radius: 4px;
    }
    #editModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
    }
    #editModalContent {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      width: 400px;
      max-width: 90%;
      max-height: 90%;
      overflow-y: auto;
    }
    #editModalContent input, #editModalContent select {
      width: 100%;
      margin-bottom: 1rem;
      padding: 0.5rem;
      font-size: 1rem;
    }
    #eventCheckboxes label {
      display: block;
      margin-bottom: 0.3rem;
    }
  </style>
</head>
<body>
  <h1>‚úèÔ∏è Edit Entries ‚Äì CDS Sports Meet</h1>
  <div id="schoolHeader"></div>
  <div class="actions">
    <button onclick="downloadCSV()">‚¨áÔ∏è Download Entries</button>
  </div>
  <div id="resultsContainer">Loading entries...</div>

  <!-- Edit Modal -->
  <div id="editModal">
    <div id="editModalContent">
      <h3>Edit Participant</h3>
      <form id="editForm">
        <input type="hidden" id="originalName">
        <input type="hidden" id="editSchool">
        <label>Name:<br><input type="text" id="editName" required></label>
        <label>DOB:<br><input type="date" id="editDob" required></label>
        <label>Gender:<br>
          <select id="editGender">
            <option>Male</option>
            <option>Female</option>
          </select>
        </label>
        <label>Age Category:<br>
          <select id="editAge">
            <option>Under 11</option>
            <option>Under 14</option>
            <option>Under 16</option>
            <option>Under 17</option>
            <option>Under 19</option>
          </select>
        </label>
        <label>Events:</label>
        <div id="eventCheckboxes" style="margin-bottom:1rem;"></div>
        <button type="submit">‚úÖ Save</button>
        <button type="button" onclick="closeModal()">‚ùå Cancel</button>
      </form>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const schoolName = urlParams.get('school');
    document.getElementById('schoolHeader').textContent = `üè´ School: ${schoolName}`;
    let schoolEntries = [];

    const allEvents = [
      "50m Race", "100m Race", "200m Race", "400m Race", "800m Race", "1500m Race",
      "Shot Put", "Discus Throw", "Long Jump", "High Jump", "4x100m Relay", "4x400m Relay"
    ];

    function loadResults() {
      fetch('/results')
        .then(res => res.json())
        .then(data => {
          const container = document.getElementById('resultsContainer');
          container.innerHTML = '';
          schoolEntries = data.filter(entry =>
            entry.school.trim().toLowerCase() === schoolName.trim().toLowerCase()
          );
          if (schoolEntries.length === 0) {
            container.innerHTML = '<p>No entries found for this school.</p>';
            return;
          }

          const table = document.createElement('table');
          table.innerHTML = `
            <tr>
              <th>Photo</th>
              <th>Name</th>
              <th>Chest</th>
              <th>DOB</th>
              <th>Age Category</th>
              <th>Gender</th>
              <th>Events</th>
              <th>Actions</th>
            </tr>
          `;

          schoolEntries.forEach(p => {
            const row = `
              <tr>
                <td><img src="${p.photoPath}" alt="Photo of ${p.name}"></td>
                <td>${p.name}</td>
                <td>${p.chest}</td>
                <td>${p.dob}</td>
                <td>${p.ageCategory}</td>
                <td>${p.gender}</td>
                <td>${p.events.join(', ')}</td>
                <td>
                  <button onclick='openEditModal(${JSON.stringify(p).replace(/'/g, "\\'")})'>Edit</button>
                  <button onclick="removeCandidate('${p.name}', '${p.school}')">Remove</button>
                </td>
              </tr>
            `;
            table.innerHTML += row;
          });

          container.appendChild(table);
        });
    }

    function openEditModal(entry) {
      document.getElementById('editModal').style.display = 'flex';
      document.getElementById('originalName').value = entry.name;
      document.getElementById('editSchool').value = entry.school;
      document.getElementById('editName').value = entry.name;
      document.getElementById('editDob').value = entry.dob;
      document.getElementById('editGender').value = entry.gender;
      document.getElementById('editAge').value = entry.ageCategory;

      const container = document.getElementById('eventCheckboxes');
      container.innerHTML = '';
      allEvents.forEach(event => {
        const checked = entry.events.includes(event) ? 'checked' : '';
        container.innerHTML += `
          <label><input type="checkbox" value="${event}" ${checked}> ${event}</label>
        `;
      });
    }

    function closeModal() {
      document.getElementById('editModal').style.display = 'none';
    }

    document.getElementById('editForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const originalName = document.getElementById('originalName').value;
      const school = document.getElementById('editSchool').value;
      const name = document.getElementById('editName').value;
      const dob = document.getElementById('editDob').value;
      const gender = document.getElementById('editGender').value;
      const ageCategory = document.getElementById('editAge').value;
      const events = Array.from(document.querySelectorAll('#eventCheckboxes input:checked')).map(cb => cb.value);

      if (events.length === 0) return alert("Please select at least one event.");

      fetch('/edit-events', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ originalName, name, school, dob, gender, ageCategory, events })
      })
        .then(res => res.text())
        .then(msg => {
          alert(msg);
          closeModal();
          loadResults();
        });
    });

    function removeCandidate(name, school) {
      if (!confirm(`Are you sure you want to remove ${name}?`)) return;

      fetch('/remove-candidate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, school })
      })
        .then(res => res.text())
        .then(msg => {
          alert(msg);
          loadResults();
        });
    }

    function downloadCSV() {
  if (schoolEntries.length === 0) return alert("No entries to download.");

  const headers = ["Name", "Chest", "DOB", "Age Category", "Gender", "Events"];
  const rows = schoolEntries.map(p => [
    `"${p.name}"`,
    `"${p.chest}"`,
    `"${p.dob}"`,
    `"${p.ageCategory}"`,
    `"${p.gender}"`,
    `"${p.events.join('; ')}"`
  ]);

  const csvContent = "data:text/csv;charset=utf-8," +
    headers.join(",") + "\n" +
    rows.map(r => r.join(",")).join("\n");

  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", `${schoolName.replace(/\s+/g, '_')}_entries.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
